/* Write your T-SQL query statement below */

/* https://leetcode.com/problems/average-time-of-process-per-machine */

/*
----first version
--first tab - tab with start time
with TabProcStart ( machine_id, timestamp )
as
(
    select
        machine_id,
        timestamp = sum ( timestamp )
    from Activity
    where activity_type = 'start'
    group by machine_id
),
--second tab - tab with end time
TabProcEnd ( machine_id, timestamp, proc_count )
as
(
    select
        machine_id,
        timestamp = sum ( timestamp ),
        proc_count = count ( process_id )
    from Activity
    where activity_type = 'end'
    group by machine_id
)
--third tab - tab with calculated time
select
    prSt.machine_id,
    processing_time = round ( ( prEnd.timestamp - prSt.timestamp ) / prEnd.proc_count, 3 )
from
    TabProcStart prSt
        inner join
    TabProcEnd prEnd on prSt.machine_id = prEnd.machine_id
*/

select
    machine_id,
    processing_time = 
        round
            ( 
                avg ( case when activity_type = 'end' then timestamp end )
                -
                avg ( case when activity_type = 'start' then timestamp end ),
                3
            )
from Activity
group by machine_id
